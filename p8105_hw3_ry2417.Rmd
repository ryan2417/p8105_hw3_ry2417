---
title: "p8105_hw3_ry2417"
author: "Ruiqi Yan"
date: "10/12/2021"
output: github_document
---

load `tidyverse` package and set global options of code chunk and figure

```{r, message = FALSE}
library(tidyverse)

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  fig.width = 6,
  fig.asp = .7,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

load `p8105.datasets` package

```{r}
library(p8105.datasets)
```


## Problem 1

load `instacart` data and tidy the data to data frame of problem 1
```{r}
data("instacart")
p1_df <- 
  instacart %>% 
  mutate(
    order_dow = lubridate::wday(order_dow + 1,
                                label = TRUE,
                                abbr = FALSE
                                )
  ) %>% 
  arrange(user_id, order_number) %>% 
  relocate(user_id, order_number, product_name, aisle, department, everything())
```

Some numerical summary of data

```{r}
num_user <-
  p1_df %>% 
  select(user_id) %>% 
  distinct() %>% 
  nrow()

num_order <-
  p1_df %>% 
  select(order_id) %>% 
  distinct() %>% 
  nrow()

num_product <-
  p1_df %>% 
  select(product_name) %>% 
  distinct() %>% 
  nrow()

most_order_dow <-
  p1_df %>% 
  group_by(order_dow) %>% 
  distinct(order_id) %>% 
  summarise(
    num_order = n()
  ) %>% 
  filter(num_order == max(num_order)) %>% 
  pull(order_dow)
  
num_dptm <-
  p1_df %>% 
  select(department) %>% 
  distinct() %>% 
  nrow()

some_dptm <- 
  p1_df %>% 
  select(department) %>% 
  distinct() %>% 
  head(10) %>% 
  pull()

num_aisle <- 
  p1_df %>% 
  select(aisle) %>% 
  distinct() %>% 
  nrow()
  
most_item_aisle <- 
  p1_df %>% 
  group_by(aisle) %>% 
  summarise(
    num_item = n()
  ) %>% 
  arrange(desc(num_item)) %>% 
  head(5) %>% 
  pull(aisle)

most_reorder_product <-
  p1_df %>% 
  group_by(product_name) %>% 
  summarise(
    num_reorder = sum(reordered)
  ) %>% 
  arrange(desc(num_reorder)) %>% 
  head(10) %>% 
  pull(product_name)
```

Some tables generated from data 

```{r}
example_obs <-
  p1_df %>% 
  head(10) %>% 
  select(user_id, 
         order_id, 
         product_name, 
         aisle, 
         department,
         order_dow,
         order_hour_of_day
  ) %>% 
  head(10) %>% 
  knitr::kable()

most_popular_product <- 
  p1_df %>% 
  group_by(product_name) %>% 
  distinct(order_id) %>% 
  summarise(
    num_product_order = n()
  ) %>% 
  arrange(desc(num_product_order)) %>% 
  head(10) %>% 
  knitr::kable()

most_popular_product_by_dptm <-
  p1_df %>% 
  group_by(department, product_name) %>% 
  distinct(order_id) %>% 
  summarise(
    num_order = n()
  ) %>% 
  mutate(
    product_rank = min_rank(desc(num_order))
  ) %>% 
  select(-num_order) %>% 
  filter(product_rank < 6) %>% 
  head(40) %>% 
  pivot_wider(
    names_from = department,
    values_from = product_name
  ) %>% 
  arrange(product_rank) %>% 
  knitr::kable()

most_popular_product_by_aisle <-
  p1_df %>% 
  filter(aisle %in% c("baking ingredients",
                      "dog food care",
                      "packaged vegetables fruits")) %>% 
  group_by(aisle, product_name) %>% 
  summarise(
    num_times = n()
  ) %>% 
  mutate(
    product_rank = min_rank(desc(num_times))
  ) %>% 
  filter(product_rank < 4) %>% 
  arrange(product_rank) %>% 
  pivot_wider(
    names_from = product_rank,
    values_from = c(product_name, num_times),
    names_glue = "Rank_{product_rank}_{.value}"
  ) %>% 
  knitr::kable()

mean_hour_of_day_dow <-
  p1_df %>% 
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) %>% 
  group_by(product_name, order_dow) %>% 
  summarise(
    mean_hour_of_day = mean(order_hour_of_day)
  ) %>% 
  pivot_wider(
    names_from = order_dow,
    values_from = mean_hour_of_day
  ) %>% 
  knitr::kable()
```

`instacart`data contains `r nrow(p1_df)` observations of  `r ncol(p1_df)` 
variables. The variables name are ``r names(p1_df)``. There are `r num_user` 
users, `r num_order` orders, `r num_product` 
different products, `r num_dptm` categories of products and `r num_aisle` aisles
. The categories of products include `r some_dptm`. Most of items were order 
aisles `most_item_aisle`. Here are some examples of observations `r example_obs`
The products that has most reordering users were `r most_reorder_product`. 
Here is the table of the most popular products and the number of times being 
ordered `r most_popular_product`
The three most popular items in each of the 
aisles “baking ingredients”, “dog food care”, and “packaged vegetables fruits” are
listed here `r most_popular_product_by_aisle`
The most popular items in some departments are shown below 
`r most_popular_product_by_dptm`

The day of the week when most orders were placed is `r most_order_dow`. The 
table showing the mean hour of the day at which Pink Lady Apples and Coffee Ice 
Cream are ordered on each day of the week is `r mean_hour_of_day_dow`

Make a plot that shows the number of items ordered in each aisle, limiting this 
to aisles with more than 10000 items ordered.

```{r problem_1_plot}
p1_df %>% 
  group_by(aisle) %>% 
  summarise(
    num_item = n()
  ) %>% 
  filter(num_item >= 10000) %>% 
  ggplot(aes(x = aisle, y = num_item)) +
  geom_bar(stat = "identity", alpha = 0.5) +
  labs(x = "aisle name",
       y = "number of items ordered",
       title = "The Number of Items Ordered in Each Aisle(>= 10000)",
       caption = "Data from instacart of p8105_datasets package ") +
  theme(
    axis.text.x = element_text(angle = 90, size = 6),
    axis.text.y = element_text(size = 6),
    axis.title = element_text(size = 7),
    plot.title = element_text(size = 7),
    plot.caption = element_text(size = 4)
  )
```


## Problem 2

load `brfss_smart2010` data

```{r}
data("brfss_smart2010")
```

clean `brfss_smart2010` data and assign to data frame of problem 2

```{r}
p2_df <- 
  brfss_smart2010 %>% 
  janitor::clean_names() %>% 
  rename(
    location = locationabbr,
    location_desc = locationdesc
  ) %>% 
  filter(topic == "Overall Health") %>% 
  mutate(
    response = factor(response, 
                      levels = c("Poor", 
                                 "Fair",
                                 "Good",
                                 "Very good",
                                 "Excellent"),
                      ordered = TRUE
                      )
  )
```

